# 実装計画

## 概要

本タスクリストは、推しトレーナー作成機能の実装手順を定義します。既存のテンプレートシステムとデータサービス層を拡張し、ユーザーが独自の推しトレーナーを作成・管理できる機能を実装します。

---

## タスク

- [x] 1. 画像永続化サービスの実装
- [x] 1.1 画像保存・読み込みサービスの実装
  - Documentsディレクトリに画像保存用ディレクトリを作成する機能
  - UIImageをPNG形式に変換してファイルシステムに保存する機能
  - ファイル名（UUID.png）からUIImageを読み込む機能
  - 画像削除機能（将来のトレーナー削除機能の基盤）
  - エラーハンドリング（ディレクトリ作成失敗、画像変換失敗、保存失敗）
  - _要件: 2.3, 2.5_

- [x] 1.2 画像永続化サービスのユニットテスト
  - 画像保存成功のテスト（UUID.pngファイルが作成される）
  - 画像読み込み成功のテスト（保存した画像を正しく読み込める）
  - 画像削除成功のテスト（ファイルが削除される）
  - ディレクトリ作成失敗時のエラーハンドリングテスト
  - PNG変換失敗時のエラーハンドリングテスト
  - _要件: 2.3, 2.5_

- [x] 2. データサービス層の拡張
- [x] 2.1 DataServiceProtocolへのトレーナーテンプレート永続化メソッドの追加
  - プロトコルに全トレーナーテンプレート取得メソッドを追加
  - プロトコルにトレーナーテンプレート保存メソッドを追加
  - プロトコルにID指定トレーナーテンプレート取得メソッドを追加
  - エラー型の定義（エンコード失敗、デコード失敗、保存失敗）
  - _要件: 9.1, 9.3, 9.4_

- [x] 2.2 MockDataServiceへのメモリ内トレーナーテンプレート管理機能の実装
  - メモリ内配列でトレーナーテンプレートを管理
  - 全トレーナーテンプレート取得機能
  - トレーナーテンプレート保存機能（配列に追加）
  - ID指定トレーナーテンプレート取得機能
  - デフォルトトレーナー「推乃 愛」のテンプレートを初期データとして含める
  - _要件: 9.1, 9.3, 9.4_

- [x] 2.3 UserDefaults実装クラスの作成
  - UserDefaultsを使用したトレーナーテンプレート永続化
  - Codableを使用したJSONエンコード/デコード
  - 全トレーナーテンプレート取得機能
  - トレーナーテンプレート保存機能（既存配列に追加して再保存）
  - ID指定トレーナーテンプレート取得機能
  - エラーハンドリング（エンコード失敗、デコード失敗）
  - _要件: 6.3, 9.3, 9.4_

- [x] 2.4 データサービス層のユニットテスト
  - MockDataServiceのトレーナー保存・取得テスト
  - UserDefaults実装のエンコード/デコードテスト
  - エラーケースのテスト（無効なデータ、エンコード失敗）
  - 複数トレーナー保存時の順序保証テスト
  - _要件: 9.3, 9.4_

- [x] 3. トレーナー作成ViewModelの実装
- [x] 3.1 トレーナー作成ViewModelの基本構造とバリデーション機能
  - 入力検証機能（名前必須、画像必須、名前文字数制限30文字）
  - デフォルト値自動設定ロジック（イメージカラー、性格、一人称・二人称）
  - エラーメッセージ管理（Published プロパティ）
  - 作成中状態管理（Published プロパティ）
  - _要件: 3.5, 3.6, 3.7, 4.3, 6.2, 6.6_

- [x] 3.2 トレーナー作成メインロジックの実装
  - 画像永続化サービスを使用した画像保存
  - OshiTrainerTemplateインスタンスの生成
  - データサービスを使用したトレーナーテンプレート保存
  - 非同期処理（async/await）
  - エラーハンドリング（画像保存失敗、データ保存失敗）
  - _要件: 6.1, 6.2, 6.3_

- [x] 3.3 ボイスサンプル再生機能の実装
  - ランダムなサンプルカテゴリの選択ロジック（レップカウント、タイマー、フォームエラー、速度フィードバック）
  - AudioFeedbackServiceを使用したサンプル音声再生
  - 再生中の他サンプル停止機能
  - ボイス名に応じた音声パス解決
  - _要件: 5.4, 5.6_

- [x] 3.4 トレーナー作成ViewModelのユニットテスト
  - 入力検証テスト（名前未入力、画像未選択、名前長すぎ）
  - デフォルト値自動設定テスト
  - トレーナー作成成功テスト
  - エラーハンドリングテスト（画像保存失敗、データ保存失敗）
  - ボイスサンプル再生テスト
  - _要件: 3.5, 3.6, 3.7, 4.3, 5.4, 6.2, 6.6_

- [x] 4. トレーナー作成画面UIの実装
- [x] 4.1 基本レイアウトとナビゲーション
  - ScrollViewベースのフォームレイアウト
  - ナビゲーションタイトル「推しトレーナー作成」（ピンクカラー）
  - Dismiss環境変数の設定
  - ウマ娘風背景カラーの適用
  - _要件: 1.4, 10.4, 10.5_

- [x] 4.2 キャラクター画像選択UIの実装
  - PhotosPickerの統合
  - 選択画像のプレビュー表示
  - 画像未選択時のプレースホルダー表示
  - 画像選択フィールドのラベルとスタイリング
  - _要件: 2.1, 2.2, 2.3_

- [x] 4.3 基本プロフィール入力フィールドの実装
  - 名前入力フィールド（TextFieldとバインディング）
  - イメージカラー選択UI（5色のカラーボタン: pink, blue, green, orange, purple）
  - 一人称入力フィールド
  - 呼び方（二人称）入力フィールド
  - フィールドラベルとスタイリング（OshiTextStyles適用）
  - _要件: 3.1, 3.2, 3.3, 3.4, 10.2_

- [x] 4.4 性格とボイス選択UIの実装
  - 性格タイプ選択Picker（tsundere, cheerful, gentle, cool）
  - ボイス選択Picker（ずんだもん、四国めたん）
  - 各ボイスのサンプル再生ボタン
  - Pickerのスタイリング（ウマ娘風）
  - _要件: 4.1, 4.2, 5.1, 5.2, 5.3_

- [x] 4.5 作成ボタンとバリデーションUI
  - 作成ボタン（OshiButtonStyle適用）
  - バリデーションによるボタンの有効/無効切り替え
  - エラーメッセージ表示（名前未入力、画像未選択）
  - 作成中のローディングインジケーター
  - 作成成功時のナビゲーション解除
  - _要件: 6.1, 6.2, 6.4, 6.6, 10.1_

- [x] 4.6 トレーナー作成画面のUIテスト
  - 画面遷移テスト（ホーム画面から作成画面へ）
  - 画像選択UIの表示テスト
  - 入力フォームの表示と入力テスト
  - 作成ボタンの有効/無効切り替えテスト
  - エラーメッセージ表示テスト
  - _要件: 1.2, 1.3, 2.1, 3.1, 4.1, 5.1, 6.1_

- [x] 5. HomeViewModelの拡張
- [x] 5.1 複数トレーナー管理機能の実装
  - データサービスから全トレーナーテンプレートを取得する機能
  - デフォルトトレーナー + ユーザー作成トレーナー + 推し追加プレースホルダーの配列生成
  - 無限ループ用の配列3倍化ロジック（既存ロジックの拡張）
  - 作成日時順でのソート機能
  - _要件: 8.1, 9.5_

- [x] 5.2 アクティブトレーナー切り替えとイメージカラー適用
  - トレーナーインデックス変更時のアクティブトレーナー更新
  - 現在のトレーナーテンプレート取得計算プロパティ
  - イメージカラーの動的取得（Color.oshiThemeColor()を使用）
  - 性格に応じたセリフ更新ロジック
  - _要件: 7.3, 7.4, 8.3_

- [x] 5.3 HomeViewModelのユニットテスト
  - トレーナーリスト読み込みテスト（デフォルト + ユーザー作成）
  - 無限ループ配列の生成テスト（3倍化、中央グループ開始）
  - アクティブトレーナー切り替えテスト
  - イメージカラー取得テスト
  - ソート順序テスト（デフォルトが先頭、作成日時順）
  - _要件: 8.1, 8.2, 8.3, 8.4, 9.5_

- [x] 6. HomeView UIの更新
- [x] 6.1 推し追加プレースホルダーの表示
  - トレーナーリスト最後に「キャラ追加」画像を表示
  - 「キャラ追加」画像タップでトレーナー作成画面へ遷移
  - プレースホルダーの判定ロジック（HomeViewModel.isAddPlaceholder()）
  - _要件: 1.1, 1.2_

- [x] 6.2 イメージカラーの動的適用
  - ボタンアクセントカラーの動的適用（設定、推し、統計ボタン）
  - 背景グラデーションカラーの動的適用
  - 現在のトレーナーのイメージカラーに基づくUI更新
  - トレーナー切り替え時のカラー再適用
  - _要件: 7.3_

- [x] 6.3 ホーム画面のナビゲーション統合
  - 「推しトレーナー作成」ボタンからの遷移
  - トレーナー作成後のリスト再読み込み
  - 新規作成トレーナーのアクティブ設定
  - _要件: 1.3, 6.4, 6.5, 7.1, 7.2_

- [x] 6.4 ホーム画面UIの統合テスト
  - 推し追加プレースホルダー表示テスト
  - トレーナースワイプ切り替えテスト
  - イメージカラー適用テスト（ボタン、背景）
  - 新規トレーナー作成後の表示テスト
  - _要件: 1.1, 7.1, 7.2, 7.3, 8.2, 8.3_

- [x] 7. 統合とエンドツーエンドテスト
- [x] 7.1 エンドツーエンドのトレーナー作成フロー
  - ホーム画面 → 作成画面遷移 → 画像選択 → 入力 → 作成 → ホーム画面戻り の全体フロー
  - 作成したトレーナーがホーム画面に表示される確認
  - イメージカラーと性格がUIに反映される確認
  - データ永続化の確認（アプリ再起動後も表示される）
  - _要件: 全要件の統合確認_

- [x] 7.2 複数トレーナー管理のテスト
  - 複数トレーナーの作成と表示順序の確認
  - 無限ループスワイプの動作確認
  - トレーナー切り替え時のUI更新確認
  - 推し追加プレースホルダーの位置確認（常に最後）
  - _要件: 8.1, 8.2, 8.3, 8.4_

- [x] 7.3 エラーケースとエッジケースのテスト
  - 画像保存失敗時のエラーハンドリング
  - UserDefaults保存失敗時のエラーハンドリング
  - 写真ライブラリ権限拒否時の動作
  - 名前30文字制限の確認
  - デフォルト値自動設定の確認
  - _要件: 3.5, 3.6, 3.7, 4.3, 6.6_

- [ ] 7.4 Info.plistのプライバシー設定
  - NSPhotoLibraryUsageDescriptionの追加（写真ライブラリアクセス理由の記述）
  - 適切な日本語説明文の設定
  - _要件: 2.2（写真ライブラリアクセス権限）_

---

## 実装順序の説明

1. **インフラストラクチャ層（タスク1-2）**: 画像永続化とデータサービス拡張を先に実装し、上位層の依存関係を満たします。
2. **ビジネスロジック層（タスク3）**: ViewModelを実装し、トレーナー作成のコアロジックを確立します。
3. **プレゼンテーション層（タスク4）**: UIを実装し、ユーザー入力を収集します。
4. **既存システムとの統合（タスク5-6）**: HomeViewModelとHomeViewを拡張し、作成したトレーナーを既存システムに統合します。
5. **統合テスト（タスク7）**: エンドツーエンドで全体フローを検証し、エッジケースを確認します。

各タスクは独立性を保ちつつ、段階的に機能を積み上げていく設計になっています。
